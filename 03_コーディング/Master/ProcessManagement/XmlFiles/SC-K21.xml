<?xml version="1.0"?>
<Configuration>
  <SC-K21>
    
    <Selects>

      <!--払出区分-->
      <SQL ID="SELECT_001">
        <Text>
          SELECT
            NULL AS 対象年月
            ,1
          UNION SELECT
            DISTINCT CONVERT(VARCHAR(7),受払年月日,111) AS 対象年月
            ,2
          FROM
            受払データ
          WHERE
            受払年月日 IS NOT NULL
          ORDER BY
            2,対象年月 DESC
        </Text>
      </SQL>
      
      <!--払出区分-->
      <SQL ID="SELECT_002">
        <Text>
          SELECT
            '' AS コード,
            '' AS コード名称
          UNION SELECT
            コード,
            (コード+ ':' +コード名称) AS コード名称
          FROM
           コードマスタ
          WHERE
            コード区分 = 'PAYMENT_CD'
          ORDER BY
           コード
        </Text>
      </SQL>

      <!--検索結果-->
      <SQL ID="SELECT_003">
        <Text>
          SELECT
            その他出庫データ.受払年月日 AS 払出年月日
            ,その他出庫データ.大工程コード AS 工程コード
            ,工程マスタ.工程略称
            ,その他出庫データ.個体NO
            ,生産品名マスタ.品名略称
            ,COUNT(その他出庫データ.個体NO) AS 払出数量
            ,その他出庫データ.備考
            ,その他出庫データ.品名コード
            ,その他出庫データ.品名事業所コード
            ,その他出庫データ.納入先コード
            ,その他出庫データ.納入区分
            ,その他出庫データ.製品半製品区分
            ,その他出庫データ.振替区分
            ,その他出庫データ.パック品名略称
            ,その他出庫データ.払出区分 
          FROM
            (
            SELECT 
              シーケンス
              ,受払年月日 
              ,大工程コード 
              ,個体NO
              ,備考
              ,品名コード
              ,品名事業所コード
              ,納入先コード
              ,納入区分
              ,受払区分
              ,製品半製品区分
              ,振替区分
              ,パック品名略称 
              ,払出区分
            FROM
            (
            SELECT 
              RANK() OVER (PARTITION BY 個体NO ORDER BY シーケンス DESC) AS RANKNO
              ,シーケンス
              ,受払年月日 
              ,大工程コード 
              ,個体NO
              ,備考
              ,品名コード
              ,品名事業所コード
              ,納入先コード
              ,納入区分
              ,受払区分
              ,製品半製品区分
              ,振替区分
              ,パック品名略称 
              ,払出区分
            FROM
              受払データ
            WHERE
              事業所コード = '{0}'
            )
            AS 最新データ
            WHERE 
              受払区分 = '8'
            AND 
              最新データ.RANKNO = '1'
            AND  
              CONVERT(VARCHAR(7),最新データ.受払年月日,111)  = '{1}'
            AND 
              最新データ.払出区分 = '{2}'
            )
            AS その他出庫データ
          LEFT JOIN 
            工程マスタ
          ON 
            その他出庫データ.大工程コード = 工程マスタ.大工程コード
          LEFT JOIN 
            生産品名マスタ
          ON 
            その他出庫データ.品名事業所コード = 生産品名マスタ.品名事業所コード
          AND 
            その他出庫データ.パック品名略称 = 生産品名マスタ.パック品名略称
          AND 
            その他出庫データ.納入先コード = 生産品名マスタ.納入先コード
          AND 
            その他出庫データ.納入区分 = 生産品名マスタ.納入区分
          AND 
            その他出庫データ.製品半製品区分 = 生産品名マスタ.製品半製品区分
          GROUP BY
            その他出庫データ.受払年月日
            ,その他出庫データ.大工程コード
            ,工程マスタ.工程略称
            ,その他出庫データ.個体NO
            ,その他出庫データ.品名コード
            ,その他出庫データ.品名事業所コード
            ,その他出庫データ.パック品名略称
            ,その他出庫データ.納入先コード
            ,その他出庫データ.納入区分
            ,その他出庫データ.製品半製品区分
            ,その他出庫データ.備考
            ,その他出庫データ.振替区分
            ,生産品名マスタ.品名略称
            ,その他出庫データ.払出区分 
          ORDER BY
            その他出庫データ.受払年月日 DESC
            ,その他出庫データ.大工程コード ASC
            ,その他出庫データ.品名コード ASC
        </Text>
      </SQL>
    </Selects>

    <!--在庫データ更新処理-->
    <Updates>
      <SQL ID="UPDATE_001">
        <Text>
          UPDATE
          在庫データ
          SET
            当月その他払出数量 = 当月その他払出数量 - '{6}'
            ,在庫数 = 在庫数 + '{6}'
            ,引当可能数量 = 引当可能数量 + '{6}'
            ,更新画面ID = '{7}'
	          ,更新者 = '{8}'
	          ,更新日 = '{9}'
          WHERE
            置き場事業所コード = '{0}'
          AND
            品名事業所コード = '{1}'
          AND
            パック品名略称 = '{2}'
          AND
            納入先コード = '{3}'
          AND
            納入区分 = '{4}'
          AND
            製品半製品区分 = '{5}'          
        </Text>
      </SQL>
    </Updates>

    <!--受払データ登録処理-->
    <Inserts>
      <SQL ID="INSERT_001">
        <Text>
          INSERT INTO
          受払データ
          (事業所コード,個体ＮＯ,.品名コード,品名事業所コード,パック品名略称,納入先コード,納入区分,製品半製品区分,大工程コード,受払年月日,受払区分,払出区分,振替区分,備考
          ,登録画面ID,登録者,登録日,更新画面ID,更新者,更新日)
          VALUES
          ('{0}','{1}','{2}','{3}','{4}','{5}','{6}','{7}','{8}','{9}','{10}','{11}','{12}','{13}'
          ,'{14}','{15}','{16}','{14}','{15}','{16}')
        </Text>
      </SQL>
    </Inserts>
    
  </SC-K21>
</Configuration>